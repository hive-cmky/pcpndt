<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form H - Single Page Application</title>
    <style>
        /* Search Section Styles */
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .loading {
            color: #6c757d;
            font-style: italic;
        }

        /* Results Section Styles */
        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .new-search-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        /* Form Container Styles - A4 OPTIMIZED */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
        }

        .form-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .form-subtitle {
            font-size: 12px;
            font-style: italic;
            margin-bottom: 8px;
        }

        .page-info {
            text-align: right;
            font-size: 11px;
            margin-bottom: 15px;
        }

        .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .form-table th {
            background-color: #f0f0f0;
            border: 1px solid #333;
            padding: 6px;
            text-align: left;
            font-weight: bold;
            vertical-align: top;
            width: 20%;
        }

        .form-table td {
            border: 1px solid #333;
            padding: 6px;
            vertical-align: top;
            height: 30px;
        }

        .serial-no {
            width: 4%;
            text-align: center;
        }

        .footer {
            margin-top: 30px;
            text-align: right;
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .signature-line {
            margin-top: 40px;
            text-align: right;
        }

        .data-field {
            min-height: 28px;
            padding: 3px;
        }

        .asterisk-note {
            font-size: 10px;
            margin-top: 3px;
            font-style: italic;
        }

        .compact-data div {
            margin-bottom: 2px;
        }

        /* A4 PRINT STYLES - FIXED FOR 1 PAGE */
        @media print {
            @page {
                size: A4;
                margin: 0.5cm;
            }

            body {
                font-size: 11px;
                line-height: 1.2;
                margin: 0;
                padding: 0;
            }

            .search-section, .results-header, .no-print {
                display: none !important;
            }

            .form-container {
                max-width: 100% !important;
                box-shadow: none !important;
                border: none !important;
                padding: 15px !important;
                margin: 0 !important;
            }

            .form-table {
                font-size: 11px !important;
                margin-bottom: 15px !important;
            }

            .form-table th,
            .form-table td {
                padding: 4px !important;
                height: 25px !important;
            }

            .header {
                margin-bottom: 15px !important;
                padding-bottom: 5px !important;
            }

            .footer {
                margin-top: 20px !important;
                padding-top: 10px !important;
            }

            .signature-line {
                margin-top: 30px !important;
            }

            /* Force single page */
            .form-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
<!-- Logo - REMOVED FROM TOP - Will be inside Form H only -->

<!-- Search Section -->
<div class="search-section no-print">
    <h2>Search Form H Applications</h2>

    <div class="filter-row">
        <div class="filter-group">
            <label for="serviceSelect">Service Name</label>
            <select id="serviceSelect">
                <option value="">Loading services...</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="districtSelect">District</label>
            <select id="districtSelect" disabled>
                <option value="">Select service first</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="applicationSelect">Application</label>
            <select id="applicationSelect" disabled>
                <option value="">Select district first</option>
            </select>
        </div>
    </div>

    <button id="searchBtn" class="search-btn" disabled>Generate Form H</button>
    <span id="loadingText" class="loading" style="display: none;">Loading Form H...</span>
</div>

<!-- Results Section -->
<div id="resultsSection" class="results-section">
    <div class="results-header no-print">
        <h2>Form H Report</h2>
        <div>
            <button id="newSearchBtn" class="new-search-btn">New Search</button>
            <button id="printBtn" class="search-btn">Print Form</button>
        </div>
    </div>

    <!-- Form H Report will be dynamically inserted here -->
    <div id="formHReport"></div>
</div>

<script>
    // DOM Elements
    const serviceSelect = document.getElementById('serviceSelect');
    const districtSelect = document.getElementById('districtSelect');
    const applicationSelect = document.getElementById('applicationSelect');
    const searchBtn = document.getElementById('searchBtn');
    const loadingText = document.getElementById('loadingText');
    const resultsSection = document.getElementById('resultsSection');
    const formHReport = document.getElementById('formHReport');
    const newSearchBtn = document.getElementById('newSearchBtn');
    const printBtn = document.getElementById('printBtn');

    // Current selections
    let currentSelections = {
        service: '',
        district: '',
        application: ''
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadServices();
        setupEventListeners();
    });

    function setupEventListeners() {
        serviceSelect.addEventListener('change', onServiceChange);
        districtSelect.addEventListener('change', onDistrictChange);
        applicationSelect.addEventListener('change', onApplicationChange);
        searchBtn.addEventListener('click', generateFormH);
        newSearchBtn.addEventListener('click', resetSearch);
        printBtn.addEventListener('click', () => window.print());
    }

    // Load services from API
    async function loadServices() {
        try {
            const response = await fetch('/api/filters/services');
            const services = await response.json();

            serviceSelect.innerHTML = '<option value="">Select Service</option>';
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service;
                option.textContent = service;
                serviceSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading services:', error);
            serviceSelect.innerHTML = '<option value="">Error loading services</option>';
        }
    }

    // When service changes, load districts
    async function onServiceChange() {
        const service = serviceSelect.value;
        currentSelections.service = service;

        if (!service) {
            districtSelect.disabled = true;
            districtSelect.innerHTML = '<option value="">Select service first</option>';
            applicationSelect.disabled = true;
            applicationSelect.innerHTML = '<option value="">Select district first</option>';
            searchBtn.disabled = true;
            return;
        }

        districtSelect.disabled = true;
        districtSelect.innerHTML = '<option value="">Loading districts...</option>';
        applicationSelect.disabled = true;
        applicationSelect.innerHTML = '<option value="">Select district first</option>';
        searchBtn.disabled = true;

        try {
            const response = await fetch(`/api/filters/districts`);
            const districts = await response.json();

            districtSelect.innerHTML = '<option value="">Select District</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
            districtSelect.disabled = false;
        } catch (error) {
            console.error('Error loading districts:', error);
            districtSelect.innerHTML = '<option value="">Error loading districts</option>';
        }
    }

    // When district changes, load applications
    async function onDistrictChange() {
        const district = districtSelect.value;
        currentSelections.district = district;

        if (!district) {
            applicationSelect.disabled = true;
            applicationSelect.innerHTML = '<option value="">Select district first</option>';
            searchBtn.disabled = true;
            return;
        }

        applicationSelect.disabled = true;
        applicationSelect.innerHTML = '<option value="">Loading applications...</option>';
        searchBtn.disabled = true;

        try {
            const response = await fetch(`/api/filters/applications?service=${currentSelections.service}&district=${district}`);
            const applications = await response.json();

            applicationSelect.innerHTML = '<option value="">Select Application</option>';
            applications.forEach(app => {
                const option = document.createElement('option');
                option.value = app.appl_ref_no;
                option.textContent = app.appl_ref_no;
                option.setAttribute('data-app', JSON.stringify(app));
                applicationSelect.appendChild(option);
            });
            applicationSelect.disabled = false;
        } catch (error) {
            console.error('Error loading applications:', error);
            applicationSelect.innerHTML = '<option value="">Error loading applications</option>';
        }
    }

    // When application changes, enable search button
    function onApplicationChange() {
        const application = applicationSelect.value;
        currentSelections.application = application;
        searchBtn.disabled = !application;
    }

    // Generate Form H report - DYNAMIC VERSION
    async function generateFormH() {
        if (!currentSelections.application) return;

        loadingText.style.display = 'inline';
        searchBtn.disabled = true;

        try {
            // Load detailed Form H data
            const response = await fetch(`/form-h/api/data?applRefNo=${currentSelections.application}`);
            const formData = await response.json();

            // Display Form H dynamically
            displayFormH(formData);
            resultsSection.style.display = 'block';

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error('Error generating form:', error);
            alert('Error generating Form H report');
        } finally {
            loadingText.style.display = 'none';
            searchBtn.disabled = false;
        }
    }

    // Display Form H report dynamically - FIXED LOGO PATH
    function displayFormH(formData) {
        formHReport.innerHTML = `
            <div class="form-container">
                <!-- LOGO INSIDE FORM H - FIXED PATH -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <img src="/images/Flag_of_Odisha.svg.png" alt="Logo" style="height: 50px;">
                </div>

                <!-- Page Header -->
                <div class="page-info">
                    Page No. <span>1</span>
                </div>

                <div class="header">
                    <div class="form-title">Form - H</div>
                    <div class="form-subtitle">[See Rule 9(5)]</div>
                    <div style="font-size: 14px; font-weight: bold; margin-top: 8px; line-height: 1.3;">
                        FORM FOR MAINTENANCE OF PERMANENT RECORD OF APPLICATIONS FOR GRANT/REJECTION OF REGISTRATION<br>
                        UNDER THE PRE-NATAL DIAGNOSTIC TECHNIQUES (REGULATION AND PREVENTION OF MISUSE) ACT, 1994
                    </div>
                </div>

                <!-- Main Form Table - COMPACT FOR A4 -->
                <table class="form-table">
                    <tr>
                        <th class="serial-no">1. Sl. No</th>
                        <td class="serial-no">${formData.serialNumber || '1'}</td>
                    </tr>

                    <tr>
                        <th>2. File number of Appropriate Authority</th>
                        <td class="data-field">${formData.fileNumber || '-'}</td>
                    </tr>

                    <tr>
                        <th>3. Date of receipt of application for grant of registration</th>
                        <td class="data-field">${formData.receiptDate || '-'}</td>
                    </tr>

                    <tr>
                        <th>4. Name, Address, Phone/Fax etc. of Applicant</th>
                        <td class="data-field compact-data">
                            <div><strong>${formData.applicantName || '-'}</strong></div>
                            <div>${formData.applicantAddress || '-'}</div>
                            ${formData.phoneNumber && formData.phoneNumber !== 'NA' ? `<div>Phone: ${formData.phoneNumber}</div>` : ''}
                            ${formData.email && formData.email !== 'NA' ? `<div>Email: ${formData.email}</div>` : ''}
                            ${formData.fax && formData.fax !== 'NA' ? `<div>Fax: ${formData.fax}</div>` : ''}
                            ${formData.applicantDetails ? `<div style="margin-top: 3px;">${formData.applicantDetails}</div>` : ''}
                        </td>
                    </tr>

                    <tr>
                        <th>
                            5. Name and address(es) of Genetic Counselling Centre* /
                            Genetic Laboratory* / Genetic Clinic* / Ultrasound Clinic* /
                            Imaging Centre*
                            <div class="asterisk-note">*Strike out whichever is not applicable</div>
                        </th>
                        <td class="data-field compact-data">
                            <div><strong>${formData.facilityName || '-'}</strong></div>
                            <div>${formData.facilityAddress || '-'}</div>
                            ${formData.facilityType ? `<div>Type: ${formData.facilityType}</div>` : ''}
                            ${formData.district ? `<div>District: ${formData.district}</div>` : ''}
                        </td>
                    </tr>

                    <tr>
                        <th>
                            6. Date of consideration by Advisory Committee and
                            recommendation of Advisory Committee, in summary
                        </th>
                        <td class="data-field">
                            ${formData.advisoryCommitteeDate && formData.advisoryCommitteeDate !== 'NA' ?
                                `<div><strong>Date: </strong>${formData.advisoryCommitteeDate}</div>` : ''}
                            ${formData.recommendationSummary && formData.recommendationSummary !== 'NA' ?
                                `<div style="margin-top: 5px;"><strong>Recommendation Summary:</strong><br>${formData.recommendationSummary}</div>` : ''}
                            ${formData.advisorySummary && formData.advisorySummary !== 'NA' ?
                                `<div style="margin-top: 5px;"><strong>Advisory Summary:</strong><br>${formData.advisorySummary}</div>` : ''}
                            ${(!formData.advisoryCommitteeDate || formData.advisoryCommitteeDate === 'NA') &&
                              (!formData.recommendationSummary || formData.recommendationSummary === 'NA') ? '-' : ''}
                        </td>
                    </tr>

                    <tr>
                        <th>
                            7. Outcome of application (state granted/rejected and date of
                            issue of orders - record date of issue of order in Form B or Form C)
                        </th>
                        <td class="data-field compact-data">
                            ${formData.outcome ? `<div><strong>Status: </strong>${formData.outcome}</div>` : ''}
                            ${formData.orderDate && formData.orderDate !== 'NA' ?
                                `<div><strong>Order Date: </strong>${formData.orderDate}</div>` : ''}
                            ${formData.formType && formData.formType !== 'NA' ?
                                `<div><strong>Form Type: </strong>${formData.formType}</div>` : ''}
                        </td>
                    </tr>

                    <tr>
                        <th>8. Registration number allotted and date of expiry of registration</th>
                        <td class="data-field compact-data">
                            ${formData.registrationNumber ?
                                `<div><strong>Registration No: </strong>${formData.registrationNumber}</div>` : ''}
                            ${formData.expiryDate && formData.expiryDate !== 'NA' ?
                                `<div><strong>Expiry Date: </strong>${formData.expiryDate}</div>` : ''}
                        </td>
                    </tr>

                    <tr>
                        <th>9. Renewals (date of renewal and renewed upto)</th>
                        <td class="data-field">
                            ${formData.renewalDetails && formData.renewalDetails !== 'NA' ?
                                formData.renewalDetails : '-'}
                        </td>
                    </tr>

                    <tr>
                        <th>10. File number in which renewals dealt</th>
                        <td class="data-field">
                            ${formData.renewalFileNumber && formData.renewalFileNumber !== 'NA' ?
                                formData.renewalFileNumber : '-'}
                        </td>
                    </tr>

                    <tr>
                        <th>11. Additional information, if any</th>
                        <td class="data-field" style="font-size: 11px;">${formData.additionalInfo || '-'}</td>
                    </tr>
                </table>

                <!-- Footer and Signature - COMPACT -->
                <div class="footer">
                    <div class="page-info">Page No. <span>1</span></div>
                    <div class="signature-line">
                        <div>Name, Designation & Signature of Appropriate Authority</div>
                        <div style="margin-top: 50px; border-top: 1px solid #333; width: 250px; margin-left: auto;">
                            <div style="text-align: center; padding-top: 3px; font-size: 11px;">
                                <span>Dr. S. K. Sharma</span><br>
                                <span>Chief District Medical Officer</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Print Button -->
            <div style="text-align: center; margin-top: 15px;" class="no-print">
                <button onclick="window.print()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Print Form
                </button>
            </div>
        `;
    }

    // Reset search form
    function resetSearch() {
        serviceSelect.value = '';
        districtSelect.value = '';
        applicationSelect.value = '';
        districtSelect.disabled = true;
        applicationSelect.disabled = true;
        searchBtn.disabled = true;
        resultsSection.style.display = 'none';
        currentSelections = { service: '', district: '', application: '' };

        // Scroll back to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>